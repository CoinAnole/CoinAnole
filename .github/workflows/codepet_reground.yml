name: CodePet Force Re-Ground

on:
  workflow_dispatch:
    inputs:
      force_reground:
        description: "Force a re-grounding run"
        required: true
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  trigger-reground:
    runs-on: ubuntu-latest
    env:
      CODEPET_TIMEZONE: America/Chicago
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Prepare pre-webhook image state (force re-ground)
        if: ${{ inputs.force_reground }}
        env:
          FORCE_REGROUND: "true"
        run: python .codepet/scripts/prepare_webhook_state.py

      - name: Commit pre-webhook state changes
        if: ${{ inputs.force_reground }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions[bot]"
          git add .codepet/state.json .codepet/stage_images
          git commit -m "Prepare force re-ground webhook state [runner]" || echo "No pre-webhook changes to commit"
          git push

      - name: Trigger Kilo Cloud Agent (force re-ground)
        if: ${{ inputs.force_reground }}
        run: |
          curl -X POST "${{ secrets.KILO_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: ${{ secrets.KILO_WEBHOOK_SECRET }}" \
            -d "{
              \"trigger_source\": \"manual_reground\",
              \"repository\": \"${{ github.repository }}\",
              \"actor\": \"${{ github.actor }}\",
              \"force_reground\": true
            }"
          echo "Force re-ground webhook triggered successfully"

      - name: Log skip decision
        if: ${{ !inputs.force_reground }}
        run: echo "force_reground input is false; skipping webhook trigger."
