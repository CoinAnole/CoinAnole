name: CodePet Force Re-Ground

on:
  workflow_dispatch:
    inputs:
      force_reground:
        description: "Force a re-grounding run"
        required: true
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  trigger-reground:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Prepare pre-webhook image state (force re-ground)
        id: pre_webhook
        if: ${{ inputs.force_reground }}
        env:
          FORCE_REGROUND: "true"
        run: python .codepet/scripts/prepare_webhook_state.py

      - name: Commit pre-webhook state changes
        if: ${{ inputs.force_reground }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions[bot]"
          git add .codepet/state.json
          git commit -m "Prepare force re-ground webhook state [runner]" || echo "No pre-webhook changes to commit"
          git push

      - name: Trigger Kilo Cloud Agent (force re-ground)
        if: ${{ inputs.force_reground }}
        run: |
          curl -X POST "${{ secrets.KILO_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: ${{ secrets.KILO_WEBHOOK_SECRET }}" \
            -d "{
              \"trigger_source\": \"manual_reground\",
              \"repository\": \"${{ github.repository }}\",
              \"actor\": \"${{ github.actor }}\",
              \"force_reground\": true,
              \"regrounding_should_reground\": ${{ steps.pre_webhook.outputs.should_reground }},
              \"regrounding_reason\": ${{ steps.pre_webhook.outputs.reason_json }},
              \"regrounding_threshold\": ${{ steps.pre_webhook.outputs.threshold }},
              \"image_edit_count_since_reset\": ${{ steps.pre_webhook.outputs.edit_count_since_reset }},
              \"image_total_edits_all_time\": ${{ steps.pre_webhook.outputs.total_edits_all_time }},
              \"evolution_just_occurred\": ${{ steps.pre_webhook.outputs.evolution_just_occurred }},
              \"current_stage_reference\": \"${{ steps.pre_webhook.outputs.current_stage_reference }}\"
            }"
          echo "Force re-ground webhook triggered successfully"

      - name: Log skip decision
        if: ${{ !inputs.force_reground }}
        run: echo "force_reground input is false; skipping webhook trigger."
